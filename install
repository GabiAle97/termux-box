#!/bin/bash

cd
echo "Termux-box modified by GabiAle97 Exclusive for RE7"
echo "Ð¡lick on allow to proceed"
termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -e storage ]; then
        rm -rf /sdcard/termux-box
        break
    else
        echo "If you denied permission, change it manually in termux app settings now"
    fi
    sleep 2
done

mkdir -p /sdcard/termux-box

echo ""
echo "Updating termux packages"
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

echo ""
echo "Installing necessary packages"
pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install proot -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install jq -y &>/dev/null

rm -rf $HOME/termux-box
mkdir -p $HOME/termux-box
cd $HOME/termux-box

wget https://github.com/GabiAle97/termux-box/raw/main/components/termux-x11-1.02.07-0-all.deb &>/dev/null
dpkg -i termux-x11-1.02.07-0-all.deb &>/dev/null
rm -rf termux-x11-1.02.07-0-all.deb

echo "Downloading preconfigured Rootfs..."
cd $HOME/termux-box
echo "Select your desired core system:"
echo "1) Default Jammy (stable, missing libs)"
echo "2) Enhanced Mantic (Performance, useful for Wine-GE)"
read core
if [ $core = 2 ]
then
    wget -q --show-progress https://github.com/GabiAle97/termux-box/releases/download/Dll_overrides/rootfs-mantic.tar.xz -O rootfs.tar.xz
else
    wget -q --show-progress https://github.com/GabiAle97/termux-box/releases/download/Dll_overrides/rootfs.tar.xz
fi

echo "Unzipping Rootfs..."
tar -xf rootfs.tar.xz
rm -rf rootfs.tar.xz


cd $HOME/termux-box/ubuntu-fs/opt
if [ $core = 2 ]
then
    touch $HOME/termux-box/ubuntu-fs/opt/mantic-core-system
fi
wget https://github.com/GabiAle97/termux-box/releases/download/mod_box/scripts.tar.gz &>/dev/null
tar -xf scripts.tar.gz
rm -rf scripts.tar.gz

cd $HOME/termux-box/
wget -N https://github.com/GabiAle97/termux-box/raw/main/scripts/termux-box &>/dev/null
chmod +x termux-box
mv termux-box $PREFIX/bin/
wget -N https://github.com/GabiAle97/termux-box/raw/main/scripts/start-proot.sh &>/dev/null
wget -N https://github.com/GabiAle97/termux-box/raw/main/scripts/start-chroot.sh &>/dev/null
chmod +x start-proot.sh
chmod +x start-chroot.sh
wget -N https://github.com/GabiAle97/termux-box/raw/main/scripts/update-scripts &>/dev/null
chmod +x update-scripts

echo "Installing patch"

cd $HOME/termux-box/ubuntu-fs/opt
wget -q --show-progress https://github.com/GabiAle97/termux-box/releases/download/Dll_overrides/patch.tar.xz
rm -rf d3d
rm -rf mesa
tar -xf patch.tar.xz
rm -rf patch.tar.xz

curl -s "https://api.github.com/repos/GloriousEggroll/wine-ge-custom/releases" | jq -r '.[].name' | wc -l > countge
curl -s "https://api.github.com/repos/Kron4ek/Wine-Builds/releases" | jq -r '.[].name' | wc -l > countkron
curl -s "https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases" | jq -r '.[].name' | wc -l > countvkd3d
expr $(cat countge) + $(cat countkron) > totalcount

cd
echo "Starting termux-box now. Next time use \"termux-box\" command to run it."
sleep 2

rm -rf "$0"
exec $PREFIX/bin/termux-box
